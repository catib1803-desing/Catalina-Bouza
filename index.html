<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mappita</title>
<style>
  body { font-family: Arial; margin: 0; padding: 0; }
  #map { height: 80vh; width: 100%; }
  #controls { padding: 10px; background: #fff; }
  #addForm input { padding: 5px; margin: 5px; }
  .location-item { margin: 6px 0; border-bottom: 1px solid #eee; padding-bottom: 5px; }
  .btn { cursor: pointer; padding: 4px 8px; border: none; border-radius: 5px; }
  .btn-edit { background: #ffa500; color: white; }
  .btn-view { background: #007bff; color: white; }
  .btn-locate { position: absolute; bottom: 20px; right: 20px; background: #007bff; color: #fff; padding: 10px; border-radius: 50%; cursor: pointer; border: none; font-size: 18px; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
<h2 style="text-align:center;">üó∫Ô∏è Mappita</h2>

<div id="controls">
  <form id="addForm">
    <input type="text" id="name" placeholder="Nombre (ej. Rappi Turbo Palermo)" required>
    <input type="text" id="address" placeholder="Direcci√≥n" required>
    <button type="submit" class="btn">‚ûï Agregar</button>
  </form>
  <div id="locationsList"></div>
</div>

<div id="map"></div>
<button id="locateBtn" class="btn-locate">üìç</button>

<script>
// === üìç CONFIGURACI√ìN INICIAL ===
const defaultLocations = [
  { name: "Rappi Turbo Almagro", address: "Tte. Gral. Juan Domingo Per√≥n 3341, C1198 CABA" },
  { name: "Rappi Turbo San Juan", address: "Av. San Juan 3536, C1233ABS CABA" },
  { name: "Rappi Turbo San Martin", address: "Av. S. Mart√≠n 2011, C1416 CABA" },
  { name: "Rappi Turbo Humboldt", address: "Humboldt 1877, C1414CTS CABA" },
  { name: "Rappi Turbo Forest", address: "Av. Forest 930, C1427CET CABA" },
  { name: "Rappi Turbo Caballito", address: "Del Barco Centenera 193, C1424AMC CABA" },
  { name: "Rappi Turbo Lavalle", address: "Lavalle 2124, C1051ABH CABA" },
  { name: "Rappi Turbo Las Heras", address: "Av. Gral. Las Heras 2299, C1127AAE CABA" },
  { name: "Rappi Turbo Baez", address: "B√°ez 243, C1426BRE CABA" },
  { name: "Rappi Turbo Monroe", address: "Av. Monroe 1616, C1428BKT CABA" },
  { name: "Rappi Turbo Belgrano", address: "Av. Belgrano 1154, C1092AAY CABA" },
  { name: "Rappi Turbo Rivadavia", address: "Av. Rivadavia 8242, C1407DYR CABA" }
];

let map = L.map('map').setView([-34.6037, -58.3816], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

let markers = {};
let locations = JSON.parse(localStorage.getItem("mappitaLocations")) || [...defaultLocations];

// === üß† FUNCIONES ===
function saveToLocalStorage() {
  localStorage.setItem("mappitaLocations", JSON.stringify(locations));
}

function renderLocations() {
  const list = document.getElementById("locationsList");
  list.innerHTML = "";
  locations.forEach((loc, i) => {
    const div = document.createElement("div");
    div.className = "location-item";
    div.innerHTML = `<b>${loc.name}</b><br>${loc.address}<br>
      <button class="btn btn-edit" onclick="editLocation(${i})">‚úèÔ∏è Editar</button>
      <button class="btn btn-view" onclick="focusLocation(${i})">üìç Ver</button>`;
    list.appendChild(div);
  });
}

async function geocodeAddress(address) {
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
  const res = await fetch(url);
  const data = await res.json();
  if (data.length > 0) return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
  return null;
}

async function addMarker(location, i) {
  const coords = await geocodeAddress(location.address);
  if (coords) {
    const marker = L.marker(coords, {
      icon: L.icon({
        iconUrl: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
        iconSize: [32, 32]
      })
    }).addTo(map).bindPopup(`<b>${location.name}</b><br>${location.address}`);
    markers[i] = marker;
  }
}

function focusLocation(i) {
  if (markers[i]) map.setView(markers[i].getLatLng(), 15);
  markers[i].openPopup();
}

async function editLocation(i) {
  const newName = prompt("Nuevo nombre:", locations[i].name);
  const newAddress = prompt("Nueva direcci√≥n:", locations[i].address);
  if (newName && newAddress) {
    locations[i].name = newName;
    locations[i].address = newAddress;
    if (markers[i]) map.removeLayer(markers[i]);
    await addMarker(locations[i], i);
    renderLocations();
    saveToLocalStorage();
  }
}

// === ‚ûï AGREGAR NUEVA DIRECCI√ìN ===
document.getElementById("addForm").addEventListener("submit", async e => {
  e.preventDefault();
  const name = document.getElementById("name").value;
  const address = document.getElementById("address").value;
  const newLoc = { name, address };
  locations.push(newLoc);
  await addMarker(newLoc, locations.length - 1);
  renderLocations();
  saveToLocalStorage();
  e.target.reset();
});

// === üìç UBICACI√ìN ACTUAL ===
document.getElementById("locateBtn").addEventListener("click", () => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      map.setView([latitude, longitude], 15);
      L.marker([latitude, longitude])
        .addTo(map)
        .bindPopup("üìç Tu ubicaci√≥n actual")
        .openPopup();
    }, err => alert("No se pudo acceder a la ubicaci√≥n"));
  } else alert("Tu navegador no soporta geolocalizaci√≥n");
});

// === üîÅ INICIALIZACI√ìN ===
(async () => {
  renderLocations();
  for (let i = 0; i < locations.length; i++) await addMarker(locations[i], i);
})();
</script>
</body>
</html>