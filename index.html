<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mappita</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { font-family: Arial, sans-serif; margin: 0; background: #fafafa; }
  #map { height: 70vh; width: 100%; }
  h1 { text-align: center; color: #ff6600; margin-top: 10px; }
  form { display: flex; gap: 8px; justify-content: center; margin: 10px; flex-wrap: wrap; }
  input, select, button {
    padding: 8px; border: 1px solid #ccc; border-radius: 4px;
  }
  button { background-color: #ff6600; color: white; cursor: pointer; border: none; }
  button:hover { background-color: #e65c00; }
  ul { list-style: none; padding: 0; max-width: 600px; margin: 10px auto; }
  li {
    background: white; margin: 6px 0; padding: 8px;
    border-radius: 5px; cursor: pointer; border: 1px solid #eee;
  }
  li:hover { background: #fff3e6; }
</style>
</head>
<body>
<h1>Mappita</h1>

<form id="form">
  <select id="tipo">
    <option value="Rappi Turbo">Rappi Turbo</option>
    <option value="Otro">Otro</option>
  </select>
  <input id="nombre" type="text" placeholder="Nombre del lugar" required />
  <input id="direccion" type="text" placeholder="Direcci贸n" required />
  <button type="submit">Agregar</button>
</form>

<div id="map"></div>
<ul id="lista"></ul>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const lugares = [
  { nombre: "Rappi Turbo Almagro", direccion: "Tte. Gral. Juan D. Per贸n 3341, CABA" },
  { nombre: "Rappi Turbo San Juan", direccion: "Av. San Juan 3536, CABA" },
  { nombre: "Rappi Turbo San Martin", direccion: "Av. San Mart铆n 2011, CABA" },
  { nombre: "Rappi Turbo Humboldt", direccion: "Humboldt 1877, Palermo, CABA" },
  { nombre: "Rappi Turbo Forest", direccion: "Av. Forest 930, CABA" },
  { nombre: "Rappi Turbo Caballito", direccion: "Del Barco Centenera 193, CABA" },
  { nombre: "Rappi Turbo Lavalle", direccion: "Lavalle 2124, CABA" },
  { nombre: "Rappi Turbo Las Heras", direccion: "Av. Gral. Las Heras 2299, CABA" },
  { nombre: "Rappi Turbo Baez", direccion: "B谩ez 243, Las Ca帽itas, CABA" },
  { nombre: "Rappi Turbo Monroe", direccion: "Av. Monroe y Monta帽eses, CABA" },
  { nombre: "Rappi Turbo Belgrano", direccion: "Av. Belgrano 1154, CABA" },
  { nombre: "Rappi Turbo Rivadavia", direccion: "Av. Rivadavia 8242, CABA" },
];

const map = L.map('map').setView([-34.6037, -58.3816], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

const iconoNaranja = L.icon({
  iconUrl: 'https://cdn-icons-png.flaticon.com/512/252/252025.png',
  iconSize: [30, 30],
  iconAnchor: [15, 30],
});

const iconoGris = L.icon({
  iconUrl: 'https://cdn-icons-png.flaticon.com/512/252/252035.png',
  iconSize: [30, 30],
  iconAnchor: [15, 30],
});

async function geocodificar(direccion) {
  try {
    const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion + ', Buenos Aires, Argentina')}`);
    const data = await resp.json();
    if (data && data[0]) return { lat: data[0].lat, lng: data[0].lon };
  } catch (e) {
    console.error(e);
  }
  return null;
}

async function agregarMarcador(nombre, direccion, tipo) {
  const coords = await geocodificar(direccion);
  const icono = coords ? iconoNaranja : iconoGris;
  const marker = L.marker(coords ? [coords.lat, coords.lng] : [-34.6, -58.45], { icon: icono })
    .addTo(map)
    .bindPopup(`<b>${nombre}</b><br>${direccion}`);

  const li = document.createElement('li');
  li.textContent = `${nombre} - ${direccion}`;
  li.onclick = () => {
    map.setView(coords ? [coords.lat, coords.lng] : [-34.6, -58.45], 15);
    marker.openPopup();
  };
  document.getElementById('lista').appendChild(li);
}

async function inicializar() {
  for (const lugar of lugares) {
    await agregarMarcador(lugar.nombre, lugar.direccion, "Rappi Turbo");
  }
}

// Mostrar ubicaci贸n actual
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    L.marker([latitude, longitude])
      .addTo(map)
      .bindPopup(" Tu ubicaci贸n actual")
      .openPopup();
    map.setView([latitude, longitude], 14);
  }, () => {
    console.warn("No se pudo acceder a tu ubicaci贸n");
  });
}

document.getElementById('form').addEventListener('submit', async e => {
  e.preventDefault();
  const nombre = document.getElementById('nombre').value;
  const direccion = document.getElementById('direccion').value;
  const tipo = document.getElementById('tipo').value;
  await agregarMarcador(nombre, direccion, tipo);
  e.target.reset();
});

inicializar();
</script>
</body>
</html>