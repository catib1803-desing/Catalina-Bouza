<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mappita</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { font-family: Arial, sans-serif; margin: 0; background: #fafafa; }
  #map { height: 75vh; width: 100%; }
  h1 { text-align: center; color: #ff6600; margin-top: 10px; }
  form { display: flex; gap: 8px; justify-content: center; margin: 10px; flex-wrap: wrap; }
  input, select, button {
    padding: 8px; border: 1px solid #ccc; border-radius: 4px;
  }
  button { background-color: #ff6600; color: white; cursor: pointer; border: none; }
  button:hover { background-color: #e65c00; }
  ul { list-style: none; padding: 0; max-width: 600px; margin: 10px auto; }
  li {
    background: white; margin: 6px 0; padding: 8px;
    border-radius: 5px; cursor: pointer; border: 1px solid #eee;
  }
  li:hover { background: #fff3e6; }
  #locate-btn {
    position: fixed;
    bottom: 20px; right: 20px;
    background-color: #ff6600; color: white;
    border: none; border-radius: 50%;
    width: 50px; height: 50px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    cursor: pointer; font-size: 24px;
  }
  #locate-btn:hover { background-color: #e65c00; }
</style>
</head>
<body>
<h1>Mappita</h1>

<form id="form">
  <select id="tipo">
    <option value="Rappi Turbo">Rappi Turbo</option>
    <option value="Otro">Otro</option>
  </select>
  <input id="nombre" type="text" placeholder="Nombre del lugar" required />
  <input id="direccion" type="text" placeholder="Direcci贸n" required />
  <button type="submit">Agregar</button>
</form>

<div id="map"></div>
<ul id="lista"></ul>

<button id="locate-btn" title="Ver mi ubicaci贸n"></button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Coordenadas verificadas manualmente (todas de CABA)
const lugares = [
  { nombre: "Rappi Turbo Almagro", coords: [-34.6051, -58.4094] },
  { nombre: "Rappi Turbo San Juan", coords: [-34.6293, -58.4086] },
  { nombre: "Rappi Turbo San Martin", coords: [-34.6048, -58.4703] },
  { nombre: "Rappi Turbo Humboldt", coords: [-34.5862, -58.4362] },
  { nombre: "Rappi Turbo Forest", coords: [-34.5847, -58.4662] },
  { nombre: "Rappi Turbo Caballito", coords: [-34.6271, -58.4358] },
  { nombre: "Rappi Turbo Lavalle", coords: [-34.6023, -58.3965] },
  { nombre: "Rappi Turbo Las Heras", coords: [-34.5897, -58.4004] },
  { nombre: "Rappi Turbo Baez", coords: [-34.5657, -58.4368] },
  { nombre: "Rappi Turbo Monroe", coords: [-34.5577, -58.4608] },
  { nombre: "Rappi Turbo Belgrano", coords: [-34.6137, -58.3834] },
  { nombre: "Rappi Turbo Rivadavia", coords: [-34.6324, -58.4844] },
];

const map = L.map('map').setView([-34.6037, -58.3816], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

const iconoNaranja = L.icon({
  iconUrl: 'https://cdn-icons-png.flaticon.com/512/252/252025.png',
  iconSize: [30, 30],
  iconAnchor: [15, 30],
});

function agregarMarcador(nombre, coords) {
  const marker = L.marker(coords, { icon: iconoNaranja })
    .addTo(map)
    .bindPopup(`<b>${nombre}</b>`);

  const li = document.createElement('li');
  li.textContent = nombre;
  li.onclick = () => {
    map.setView(coords, 16);
    marker.openPopup();
  };
  document.getElementById('lista').appendChild(li);
}

function inicializar() {
  lugares.forEach(lugar => agregarMarcador(lugar.nombre, lugar.coords));
}

// Geocodificar nuevas direcciones agregadas por el usuario
async function geocodificar(direccion) {
  try {
    const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion + ', Buenos Aires, Argentina')}`);
    const data = await resp.json();
    if (data && data[0]) return { lat: data[0].lat, lng: data[0].lon };
  } catch (e) {
    console.error(e);
  }
  return null;
}

document.getElementById('form').addEventListener('submit', async e => {
  e.preventDefault();
  const nombre = document.getElementById('nombre').value;
  const direccion = document.getElementById('direccion').value;
  const coords = await geocodificar(direccion);
  if (!coords) return alert("No se encontr贸 la direcci贸n: " + direccion);
  agregarMarcador(nombre, [coords.lat, coords.lng]);
  e.target.reset();
});

inicializar();

// Bot贸n de ubicaci贸n actual
let userMarker;
document.getElementById('locate-btn').addEventListener('click', () => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      if (userMarker) map.removeLayer(userMarker);
      userMarker = L.marker([latitude, longitude]).addTo(map)
        .bindPopup(" Est谩s aqu铆")
        .openPopup();
      map.setView([latitude, longitude], 15);
    }, () => alert("No se pudo acceder a tu ubicaci贸n"));
  } else {
    alert("Tu dispositivo no permite obtener ubicaci贸n");
  }
});
</script>
</body>
</html>